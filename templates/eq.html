<!doctype html>

<!-- example taken from here: https://jqueryui.com/slider/#multiple-vertical -->

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>jQuery UI Slider - Multiple sliders</title>
<!--   <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->
  <link rel="stylesheet" href="/static/jquery-ui.css">
<!--  <script src="https://jqueryui.com/slider/../../external/jquery/jquery.js"></script>
  <script src="https://jqueryui.com/slider/../../ui/core.js"></script>
  <script src="https://jqueryui.com/slider/../../ui/widget.js"></script>
  <script src="https://jqueryui.com/slider/../../ui/mouse.js"></script>
  <script src="https://jqueryui.com/slider/../../ui/slider.js"></script> -->
<!--  <script src="/static/jquery.js"></script>
  <script src="/static/core.js"></script>
  <script src="/static/widget.js"></script>
  <script src="/static/mouse.js"></script>
  <script src="/static/slider.js"></script> -->
<!--   <link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css"> -->
  <link rel="stylesheet" href="/static/style.css">
  <style>
  #gain > span {
    height:120px; float: left; margin:15px
  }
  #freq > span {
    height:120px; float: left; margin:15px
  }
  #bandwidth > span {
    height:120px; float: left; margin:15px
  }
  </style>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="/static/math.min.js"></script>
  
  
  <script>
        eq_offset = 0;
        y_scaling = 0.2;
        function fun1(x) {  return math.evaluate("re(exp(2*"+x+"*(i-0.2)))");  }
        function fun2(x) {return Math.cos(3*x);}
        function eq_response(x) { 
           var f = Math.exp(Math.log(20)+x/10.*(Math.log(20000)-Math.log(20)));
//            return single_filter_response_db( f,
//              slider_properties[0]["gain"],
//              slider_properties[0]["freq"],
//              slider_properties[0]["bandwidth"]
//            )/30
              return full_filter_response(f) * y_scaling;
        } // display +-10 db // convert x to frequency, x=10 -> f=20000
        
        function draw() {
         var canvas = document.getElementById("canvas");
         if (null==canvas || !canvas.getContext) return;
        
         var axes={}, ctx=canvas.getContext("2d");
         
//          clear canvas
         ctx.clearRect(0, 0, canvas.width, canvas.height);
//          axes.x0 = .5 + .5*canvas.width;  // x0 pixels from left to x=0
         axes.x0 = 0;// + .05*canvas.width;  // x0 pixels from left to x=0
         axes.x1 = 0 + 1*canvas.width;  
         axes.y0 = .5 + .5*canvas.height; // y0 pixels from top to y=0
         axes.scale = canvas.width*1/10;                 // 10 from 20 to 20k Hz
//          axes.doNegativeX = true;
         axes.doNegativeX = false;
        
         showAxes(ctx,axes);
//          funGraph(ctx,axes,fun1,"rgb(11,153,11)",1); 
//          funGraph(ctx,axes,fun2,"rgb(66,44,255)",2);
         funGraph(ctx,axes,eq_response,"rgb(200,0,0)",3);
        }
        
        function funGraph (ctx,axes,func,color,thick) {
         var xx, yy, dx=4, x0=axes.x0, y0=axes.y0, scale=axes.scale;
         var iMax = Math.round((ctx.canvas.width-x0)/dx);
         var iMin = axes.doNegativeX ? Math.round(-x0/dx) : 0;
         ctx.beginPath();
         ctx.lineWidth = thick;
         ctx.strokeStyle = color;
        
         for (var i=iMin;i<=iMax;i++) {
          xx = dx*i; yy = scale*func(xx/scale);
          if (i==iMin) ctx.moveTo(x0+xx,y0-yy);
          else         ctx.lineTo(x0+xx,y0-yy);
         }
         ctx.stroke();
        }
        
        function showAxes(ctx,axes) {
         var x0=axes.x0, w=ctx.canvas.width;
         var x1=axes.x1, w=ctx.canvas.width;
         var y0=axes.y0, h=ctx.canvas.height;
         var xmin = axes.doNegativeX ? 0 : x0;
         ctx.beginPath();
         ctx.strokeStyle = "rgb(128,128,128)"; 
         ctx.moveTo(xmin,y0); ctx.lineTo(w,y0);  // X axis
         ctx.moveTo(x0,0);    ctx.lineTo(x0,h);  // Y axis
         ctx.moveTo(x1,0);    ctx.lineTo(x1,h);  // Y axis
         ctx.stroke();
        }
  
  
  </script>
  
  
  
  
  
  
  
  
  <script>
  
  
  function full_filter_response(x){
  
    var eval_string = "";
    
    for ( i = 0 ; i< 12 ; i++){
        var twopowN = Math.pow(2,slider_properties[i]["bandwidth"]); // bandwidth in octaves
        var Q_of_N = Math.sqrt(twopowN)/(twopowN-1);
        var g     = Math.pow(10,slider_properties[i]["gain"]/10);
        var omega = x / slider_properties[i]["freq"]; // frequency normalized by filter frequency
        var B     = 1/Q_of_N;
        var omega_sqr = omega*omega;
        eval_string += "((-1*"+omega_sqr+"+"+g*B*omega+"*i +1 )/(-1*"+omega_sqr+"+"+B*omega+"*i + 1))*";
        
    }
    eval_string += "1";
    return 10*Math.log10( math.evaluate("abs("+eval_string+")"));
  }
  
  var slider_properties = {};
  
  function update_backend(filter_chan){
    
    var gain       = slider_properties[filter_chan]["gain"];
    var freq       = slider_properties[filter_chan]["freq"];
    var bandwidth  = slider_properties[filter_chan]["bandwidth"];
    
    $( "#amount" ).html( "ch "+filter_chan + " gain " + gain + " freq " + freq + " bandwidth (oct) " + bandwidth);
    
    eq_offset = gain/10;
    draw();
    
    $.ajax({
        url : '/set_eq?filter_chan=' + filter_chan + '&bandwidth=' + bandwidth +'&freq=' + freq + '&gain=' + gain,
        success: function(data) {
        } })  
    return 1;
  
  }
  
  
  
  $( function() {
    // setup graphic EQ
    $( "#gain > span" ).each(function() {
      // read initial values from markup and remove that
      var val_list    = $(this).text().split("-");
      
      var filter_chan = parseInt  ( val_list[0], 10 );
      var freq        = parseFloat  ( val_list[1], 10 );
      var bandwidth   = parseFloat( val_list[2]);
      var gain       = parseInt  ( val_list[3], 10 );
      
      slider_properties[filter_chan] = {}
      
      slider_properties[filter_chan]["freq"]       = freq;
      slider_properties[filter_chan]["default_freq"]       = freq;
      slider_properties[filter_chan]["bandwidth"]  = bandwidth;
      slider_properties[filter_chan]["default_bandwidth"]  = bandwidth;
      slider_properties[filter_chan]["gain"]       = gain;
      slider_properties[filter_chan]["default_gain"]       = gain;
      
      $("#freq").append("<span>"+filter_chan+"</span>");
      $("#bandwidth").append("<span>"+filter_chan+"</span>");
      
      $( this ).empty().slider({
        
        value: gain,
        range: "min",
        min:-48,
        max:15,
        animate: true,
        orientation: "vertical",
        slide: function( event, ui ) {
        
        
            var filter_chan = $(this).index();
            slider_properties[filter_chan]["gain"] = ui.value;
            update_backend(filter_chan);
           
        }
      });
    });
    
    $( "#freq > span" ).each(function() {
    
      var filter_chan = $(this).index();
      $( this ).empty().slider({
        
        value: (Math.log(slider_properties[filter_chan]["freq"]) - Math.log(20))/(Math.log(20000)-Math.log(20))*100,
        range: "min",
        min:0,
        max:100,
        animate: true,
        orientation: "vertical",
        slide: function( event, ui ) {
        
        
            var filter_chan = $(this).index();
            slider_properties[filter_chan]["freq"] = Math.exp(Math.log(20)+ui.value/100.*(Math.log(20000)-Math.log(20)));
            update_backend(filter_chan);
           
        }
      });
       
    });
    
    $( "#bandwidth > span" ).each(function() {
    
      var filter_chan = $(this).index();
      $( this ).empty().slider({
        
        value: parseInt(60*slider_properties[filter_chan]["bandwidth"]),
        range: "min",
        min:1,
        max:120,
        animate: true,
        orientation: "vertical",
        slide: function( event, ui ) {
        
        
            var filter_chan = $(this).index();
            slider_properties[filter_chan]["bandwidth"] = ui.value/60;
            update_backend(filter_chan);
           
        }
      });
       
    });
    
    $( "#reset" ).click(function(){
      for (i = 0; i<12 ; i++){
        slider_properties[i]["gain"]      = slider_properties[i]["default_gain"];
        slider_properties[i]["freq"]      = slider_properties[i]["default_freq"];
        slider_properties[i]["bandwidth"] = slider_properties[i]["default_bandwidth"];
        
        $("#gain > span").eq(i).slider("value",slider_properties[i]["default_gain"]);
        $("#freq > span").eq(i).slider("value",slider_properties[i]["default_freq"]);
        $("#bandwidth > span").eq(i).slider("value",slider_properties[i]["default_bandwidth"]);
        
//         $("#freq:nth-child("+i+")").val(slider_properties[i]["default_freq"]);
//         $("#freq:nth-child("+i+")").slider("refresh")
//         $("#gain:nth-child("+i+")").val(slider_properties[i]["default_gain"]);
//         $("#gain:nth-child("+i+")").slider("refresh")
//         $("#bandwidth:nth-child("+i+")").value = slider_properties[i]["default_bandwidth"];



      }
//         update_backend(i);
    });
    
  } );
  </script>
</head>
<body>
 
<!--<p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px;">
  <span class="ui-icon ui-icon-volume-on" style="float:left; margin:-2px 5px 0 0;"></span>
  Master volume
</p> -->
<!-- <p id="amount">0</p> -->
<!--<div id="master" style="width:260px; margin:15px;"></div> -->
 
<!--<p class="ui-state-default ui-corner-all" style="padding:4px;margin-top:4em;">
  <span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
  Graphic EQ
</p> -->

<body onload="draw()">
<canvas id="canvas" width="550" height="300"></canvas>
 
<p><button id="reset">reset</button></p>
<p id="amount">0</p>
<div id="gain">
<!--   channel - freq (Hz) - bandwidth (octaves) - init -->
  <span id="gain0" >0-40-0.66-0</span>
  <span id="gain1" >1-63-0.66-0</span>
  <span>2-100-0.66-0</span>
  <span>3-160-0.66-0</span>
  <span>4-250-0.66-0</span>
  <span>5-400-0.66-0</span>
  <span>6-630-0.66-0</span>
  <span>7-1000-0.66-0</span>
  <span>8-1600-0.66-0</span>
  <span>9-2500-0.66-0</span>
  <span>10-4000-0.66-0</span>
  <span>11-6300-0.66-0</span>
</div>

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<div id="freq">
</div>

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<div id="bandwidth">
</div>
 
 
</body>
</html>
